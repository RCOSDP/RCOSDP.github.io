# 利用申請が必要か判定するAPI

-   目的・用途

本機能はアイテムのコンテンツをダウンロードする際に、利用申請が必要かどうかを判定するAPIである。

-   利用方法

APIを実行する。

-   利用可能なロール

| ロール             | システム管理者 | リポジトリ管理者 | コミュニティ管理者 | 登録ユーザー | 一般ユーザー | ゲスト(未ログイン) |
|:------------------:|:-------------:|:---------------:|:------------------:|:-----------:|:-----------:|:----------------:|
| 利用可否           | ○             | ○               | ○                  | ○           | ○           | ○                |

-   機能内容


-   指定したアイテム内のコンテンツをログインユーザーがダウンロードする際に利用申請が必要かどうかを判定する。


-   関連モジュール


-   weko_records_ui/permissions.py

-   weko_records_ui/utils.py


-   処理概要


-   OAuth2認証機能を用いてユーザーの適切なアクセス制限を行う。

-   サーバー負荷軽減のためリクエストのアクセス制限機能をかける。

-   リクエスト

    -   API仕様書を参照

-   レスポンス

    -   API仕様書を参照

-   APIの処理の流れ

    -   レコードIDからレコードメタデータを取得する。

        -   ワークフローが完了していない場合は404エラー。

    -   レコードメタデータからファイル一覧を取得する(get_file_info_list)。

    -   ファイルでループ

        -   ファイルのアクセス権限を確認する(check_file_download_permission)。

        -   利用申請が必要なファイルか確認する(check_content_clickable)。

        -   アクセス権限なし、かつ、利用申請が必要なファイルの場合は、利用申請が必要と判定する。


-   更新履歴

| 日付      | 更新内容 |
|----------|----------|
|2023/7/14 |初版作成   |
